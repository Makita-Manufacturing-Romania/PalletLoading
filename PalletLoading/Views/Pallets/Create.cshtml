@model PalletLoading.ViewModels.AddContainerViewModel
@{
    ViewData["Title"] = "Create";
}
<style>

    #loader-1 {
        display: none;
        left: 50%;
        position: relative;
    }

        #loader-1 #loader {
            position: absolute;
            height: 5vw;
            width: 5vw;
            border: 6px solid transparent;
            border-top-color: #3498db;
            border-bottom-color: #3498db;
            border-radius: 50%;
            z-index: 2;
            -webkit-animation: spin 2s linear infinite;
            -moz-animation: spin 2s linear infinite;
            -o-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }

            #loader-1 #loader:before {
                content: "";
                position: absolute;
                top: 2%;
                bottom: 2%;
                left: 2%;
                right: 2%;
                border: 4px solid transparent;
                z-index: 2;
                border-top-color: #db213a;
                border-radius: 50%;
                -webkit-animation: spin 3s linear infinite;
                -moz-animation: spin 3s linear infinite;
                -o-animation: spin 3s linear infinite;
                animation: spin 3s linear infinite;
            }

            #loader-1 #loader:after {
                content: "";
                position: absolute;
                top: 5%;
                bottom: 5%;
                left: 5%;
                right: 5%;
                border: 3px solid transparent;
                border-top-color: #dec52d;
                z-index: 2;
                border-radius: 50%;
                -webkit-animation: spin 1.5s linear infinite;
                -moz-animation: spin 1.5s linear infinite;
                -o-animation: spin 1.5s linear infinite;
                animation: spin 1.5s linear infinite;
            }

    /*Keyframes for spin animation */

    @@-webkit-keyframes spin {
        0% {
            -webkit-transform: rotate(0deg); /* Chrome, Opera 15+, Safari 3.1+ */
            -ms-transform: rotate(0deg); /* IE 9 */
            transform: rotate(0deg); /* Firefox 16+, IE 10+, Opera */
        }

        50% {
            -webkit-transform: rotate(360deg); /* Chrome, Opera 15+, Safari 3.1+ */
            -ms-transform: rotate(360deg); /* IE 9 */
            transform: rotate(180deg); /* Firefox 16+, IE 10+, Opera */
        }

        100% {
            -webkit-transform: rotate(360deg); /* Chrome, Opera 15+, Safari 3.1+ */
            -ms-transform: rotate(360deg); /* IE 9 */
            transform: rotate(360deg); /* Firefox 16+, IE 10+, Opera */
        }
    }


    @@-moz-keyframes spin {
        0% {
            -webkit-transform: rotate(0deg); /* Chrome, Opera 15+, Safari 3.1+ */
            -ms-transform: rotate(0deg); /* IE 9 */
            transform: rotate(0deg); /* Firefox 16+, IE 10+, Opera */
        }

        50% {
            -webkit-transform: rotate(360deg); /* Chrome, Opera 15+, Safari 3.1+ */
            -ms-transform: rotate(360deg); /* IE 9 */
            transform: rotate(180deg); /* Firefox 16+, IE 10+, Opera */
        }

        100% {
            -webkit-transform: rotate(360deg); /* Chrome, Opera 15+, Safari 3.1+ */
            -ms-transform: rotate(360deg); /* IE 9 */
            transform: rotate(360deg); /* Firefox 16+, IE 10+, Opera */
        }
    }

    @@-o-keyframes spin {
        0% {
            -webkit-transform: rotate(0deg); /* Chrome, Opera 15+, Safari 3.1+ */
            -ms-transform: rotate(0deg); /* IE 9 */
            transform: rotate(0deg); /* Firefox 16+, IE 10+, Opera */
        }

        50% {
            -webkit-transform: rotate(360deg); /* Chrome, Opera 15+, Safari 3.1+ */
            -ms-transform: rotate(360deg); /* IE 9 */
            transform: rotate(180deg); /* Firefox 16+, IE 10+, Opera */
        }

        100% {
            -webkit-transform: rotate(360deg); /* Chrome, Opera 15+, Safari 3.1+ */
            -ms-transform: rotate(360deg); /* IE 9 */
            transform: rotate(360deg); /* Firefox 16+, IE 10+, Opera */
        }
    }

    @@keyframes spin {
        0% {
            -webkit-transform: rotate(0deg); /* Chrome, Opera 15+, Safari 3.1+ */
            -ms-transform: rotate(0deg); /* IE 9 */
            transform: rotate(0deg); /* Firefox 16+, IE 10+, Opera */
        }

        50% {
            -webkit-transform: rotate(360deg); /* Chrome, Opera 15+, Safari 3.1+ */
            -ms-transform: rotate(360deg); /* IE 9 */
            transform: rotate(180deg); /* Firefox 16+, IE 10+, Opera */
        }

        100% {
            -webkit-transform: rotate(360deg); /* Chrome, Opera 15+, Safari 3.1+ */
            -ms-transform: rotate(360deg); /* IE 9 */
            transform: rotate(360deg); /* Firefox 16+, IE 10+, Opera */
        }
    }
</style>




<h1 style="text-align:center">Add pallets</h1>

@{
    var type = Model.Type;
    var lengthContainer = Model.Container.NoOfColumns;
    var widthContainer = Model.Container.NoOfRows;

    var totalLayer = lengthContainer * widthContainer;
    var palletsAux = Model.Pallets;

    var containerName = Model.Container.Name;
    string countryName = "default";
    if (Model.Container.Country != null)
        countryName = Model.Container.Country.Abbreviation;

}

<br />
<div class="mb-2 mr-2" style="float:right">
    <a class="btn btn-info" asp-action="Details" asp-controller="Containers2" asp-route-id="@Model.Container.Id" />Details</a>
</div>

<div class="container">
    <div class="col-lg-6" style="float:right;">
        <h5 style="text-align:right">Max pallets per layer: @totalLayer</h5>
    </div>
    <div class="col-lg-6">
        <h5>
            Client:
            @{
                string virgula = ",";
                foreach (var country in Model.Countries)
                {
                    @country.Name
                    if(country.Id != Model.Countries.Last().Id)
                    {
                        @virgula
                    }
                }
            }
        </h5>
        <h5>Container: @containerName</h5>
        <h5>Picked pallets: @ViewData["pickedPallets"]</h5>
        <div class="form-group">
            <div align="left">
                <label asp-for="Container.CountryId" class="control-label"></label>
                <select id="newCountry" asp-for="Container.CountryId" class="form-control" asp-items="ViewBag.CountryId"></select>
            </div>
            <input type="button" value="Add client" class="btn btn-success" id="addClient" />
        </div>
    </div>
</div>

<br />
<br />
<div class="container">
    <div class="row">
        <div class="col-md-5">

            <h4><b>Finished Product:</b> <span style="font-size:20px;" > <span id="l250">@Model.idplp.LOADED250</span> (Loaded) / <span id="p250">@Model.idplp.PICKED250</span> (Picked) </span></h4>
            <h4><b>Spares:</b> <span style="font-size:20px;"><span id="l180">@Model.idplp.LOADED180</span> (Loaded) / <span id="p180">@Model.idplp.PICKED180</span> (Picked) </span></h4>
        </div>
        <div class="col-md-1" style="display:flex; justify-content: center;align-items: center;">
            <input class="btn btn-primary btn-sm" value="Actualizare" type="button" id="updateLPBtn"/>
        </div>

    </div>
</div>
<input type="hidden" value="@Model.Container.Id" id="container" />
<table border="1" class="table-bordered" style="border:2px solid; border-right-style:dotted; width: 100%; height: 100%; text-align: center; align-content: center;">
    <tbody>
        @{
            var colNo = 1;
            var currentRow = 1;
            @for (int row = 0; row < widthContainer; row++)
            {
                var heightCustom = 100;
                <tr style="width:200px; height:@heightCustom.ToString()px; vertical-align: top">
                    @for (int col = 0; col < lengthContainer; col++)
                    {
                        string idPallet = row.ToString() + "," + col.ToString();
                        var currentPallets = palletsAux.Where(x => x.Row == row && x.Column == col).OrderByDescending(x => x.OrderNo);

                        if (currentPallets != null)
                        {
                            @if (currentPallets.Count() == 1)
                            {
                                <td ondrop="drop(event)" ondragover="allowDrop(event)" style="width:200px; position:relative;height:@heightCustom.ToString()px; vertical-align: top;">
                                    @if (currentRow == 1)
                                    {
                                        <p style="font-size:25px">@colNo</p>
                                        colNo++;
                                    }
                                    <div style="position:absolute; bottom:0; width:95%">
                                        @{
                                            var pallet = currentPallets.First();
                                            <input type="button" id="@idPallet" value="Add" style="top:0; width:100%; height:@heightCustom.ToString()px;" class="addBtn btn-secondary">
                                            if (pallet.PalletImportData != null)
                                            {
                                                <input draggable="true" ondragstart="drag(event)" type="button" id="@pallet.Id" value="@pallet.OrderNo" style="width:100%; height:@heightCustom.ToString()px;" class="removeBtn btn-danger">
                                            }
                                            <br />
                                            @foreach (var palet in currentPallets)
                                            {
                                                <input draggable="true" ondragstart="drag(event)" type="button" id="@palet.Id" value="@palet.OrderNo" style="width:100%; height:@heightCustom.ToString()px;" class="removeBtn btn-danger">
                                            }
                                        }
                                    </div>
                                </td>

                            }
                            else
                            {
                                <td ondrop="drop(event)" ondragover="allowDrop(event)" style="width:200px; height:@heightCustom.ToString()px; vertical-align: top;">

                                    @if (currentRow == 1)
                                    {
                                        <p style="font-size:25px">@colNo</p>
                                        colNo++;
                                    }
                                    <br />
                                    <input type="button" id="@idPallet" value="Add" style="width:100%; height:@heightCustom.ToString()px;" class="addBtn btn-secondary">
                                    @foreach (var palet in currentPallets)
                                    {
                                        <input draggable="true" ondragstart="drag(event)" type="button" id="@palet.Id" value="@palet.OrderNo" style="width:100%; height:@heightCustom.ToString()px;" class="removeBtn btn-danger">
                                    }
                                </td>
                            }
                            @*<td style="width:200px; height:@heightCustom.ToString()px; text-align:center; table-layout:fixed; margin-top: 0;">
                                    <input type="button" id="@idPallet" value="Add" style="width:100%; height:@heightCustom-5.ToString()px; text-align:center" class="addBtn btn-secondary">
                                    @foreach (var palet in currentPallets)
                                    {
                                        <input type="button" id="@palet.Id" value="@palet.OrderNo" style="width:100%; height:@heightCustom-5.ToString()px; text-align:center" class="removeBtn btn-danger">
                                    }
                                </td>*@
                        }
                        else
                        {
                            <input type="button" id="@idPallet" value="Add" style="width:100%; height:100%; text-align:center" class="addBtn btn-secondary">
                        }



                        @*                if (pallet != null)
                            {
                                    <td style="width:200px; height:200px; text-align:center">
                                        <0form><input type="button" id="@idPallet" value="Add" text-align: center class="btn-secondary addBtn"></form>
                                        <br />
                                        <form><input type="button" id="@idPallet" value="@pallet.OrderNo" style="width:100%; height:100%; text-align:center" class="removeBtn btn-danger"></form>
                                    </td>
                                }
                                else
                                {
                                    <td style="color: white; width: 200px; height: 200px; text-align:center">
                                        <form><input type="button" id="@idPallet" value="Add" style="width:100%; height:100%; text-align:center" class="addBtn btn-secondary"></form>
                                    </td>
                                }

                                palletsAux.Remove(pallet);*@
                    }
                    @{
                        currentRow++;
                    }
                </tr>
            }
        }
    </tbody>
</table>
<br />

<div style="display:flex; justify-content:space-between">
    <div class="mb-2 mr-2">
        <input type="button" value="New row" class="btn btn-dark" id="newRow" />
        <input type="button" value="Remove row" class="btn btn-danger" id="removeRow" />
    </div>

    <div class="mb-2 mr-2">
        <input type="button" value="New column" class="btn btn-dark" id="newColumn" />
        <input type="button" value="Remove column" class="btn btn-danger" id="removeColumn" />
    </div>
</div>

<br />
<div style="width:100%" align="center">
    <form asp-action="Create" style="width:200px;">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <!--<div class="form-group">
            <label asp-for="Pallet.PalletType" class="control-label"></label>-->
        @*<select asp-for="PalletType" class="form-control" asp-items="ViewBag.PalletId" id="selectedType"></select>*@
        <!--<select asp-for="Pallet.PalletType" class="form-control" asp-items="ViewBag.PalletId"></select>
        </div>
        <div class="form-group" style="text-align:right">
            <input type="submit" value="Add" class="btn btn-success" />
        </div>-->
    </form>
</div>

<div style="width:100%; position:relative;">
    <div style="width: 100%; margin-top:-2.5vh; position:absolute;">
        <div class="loader-wrapper" id="loader-1">
            <div id="loader"></div>
        </div>
    </div>
</div>
<input type="button" value="Sincronizare paleti" class="btn btn-dark" id="sincData" />

<div id="content" class="html-content">
    @{
        @foreach (var ceva in Model.SwitchedPallets)
        {
            <table align="center">
                <tr>
                    <td>
                        @ceva.FirstPallet <-> @ceva.SecondPallet
                    </td>
                    <hr />
                </tr>
            </table>
        }
    }
</div>

<br />

<div id="tableSection">

</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
<script>

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        ev.dataTransfer.setData("drag", ev.target.id);
    }

    function drop(ev) {
        ev.preventDefault();
        var draggedPallet = ev.dataTransfer.getData("drag");
        ev.target.appendChild(document.getElementById(draggedPallet));

        var idContainer = $('#container').val();
        var droppedPallet = ev.target.id;
        var path = '@Url.Action("SwitchPallets")' + "?idContainer=" + idContainer + "&draggedPallet=" + draggedPallet + "&droppedPallet=" + droppedPallet;
        window.location.href = path;
    }

    $("#newRow").click(function () {
        var idContainer = $('#container').val();
        var path = '@Url.Action("AddRow")' + "?idContainer=" + idContainer;
        window.location.href = path;
    });

    $("#addClient").click(function () {
        var idContainer = $('#container').val();
        var idCountry = $('#newCountry').val();
        var path = '@Url.Action("AddCountry")' + "?container=" + idContainer + "&country=" + idCountry;
        window.location.href = path;
    });

        $("#updateLPBtn").click(function () {
            $("#updateLPBtn").attr("disabled", "true");
            var countryName = "@countryName";

            $.ajax({
                url: "/Pallets/GetLP",

                data: {
                    country: '' + countryName
                },

                cache: false,
                contentType: "application/json;charset=UTF-8",
                dataType: "json",
                success: function (data) {

                    $("#updateLPBtn").removeAttr("disabled");
                    $("#l250").text("" + data.importLP.loadeD250);
                    $("#l180").text("" + data.importLP.loadeD180);
                    $("#p250").text("" + data.importLP.pickeD250);
                    $("#p180").text("" + data.importLP.pickeD180);
                }
            });
        });


    $("#sincData").click(function () {
        var idContainer = $('#container').val();
        var containerName = "@containerName";
        var countryName = "@countryName";
        var thisBtn = $(this);
        $("#loader-1").show()
        $(this).attr('disabled','true')

        $.ajax({
            url: "/Pallets/GetPallets",

            data: {
                country: ''+countryName, container: ''+containerName, containerId: idContainer
            },

            cache: false,
            contentType: "application/json;charset=UTF-8",
            dataType: "json",
            success: function (data) {

                var noPallets = data.listPallets.length;
                var tableTxt = "<table class='table' style='margin-top:25px;'><tr><th>Order no</th><th>Sales part</th><th>Pallet no</th><th>Serial from</th><th>Serial to</th><th>Quantity</th><th>Weight</th></tr>"

                for (var i = 0; i < noPallets; i++) {
                    var orderNo = data.listPallets[i].orderNoApp;
                    if (orderNo == -1) orderNo = "N/A"
                    /*console.log(data.listPallets[i].palletMapHistory)*/
                    if (data.listPallets[i].palletMapHistory == null) {
                        tableTxt = tableTxt + "<tr><td>" + orderNo + "</td>"
                            + "<td>" + data.listPallets[i].palletMap.salse_part + "</td>"
                            + "<td>" + data.listPallets[i].palletMap.pallet_no + "</td>"
                            + "<td>" + data.listPallets[i].palletMap.serial_from + "</td>"
                            + "<td>" + data.listPallets[i].palletMap.serial_to + "</td>"
                            + "<td>" + data.listPallets[i].palletMap.picking_qty + "</td>"
                            + "<td>" + data.listPallets[i].palletMap.weight + "</td></tr>"
                    } else {
                        tableTxt = tableTxt + "<tr><td>" + orderNo + "</td>"
                            + "<td>" + data.listPallets[i].palletMapHistory.salse_part + "</td>"
                            + "<td>" + data.listPallets[i].palletMapHistory.pallet_no + "</td>"
                            + "<td>" + data.listPallets[i].palletMapHistory.serial_from + "</td>"
                            + "<td>" + data.listPallets[i].palletMapHistory.serial_to + "</td>"
                            + "<td>" + data.listPallets[i].palletMapHistory.picking_qty + "</td>"
                            + "<td>" + data.listPallets[i].palletMapHistory.weight + "</td></tr>"
                    }

                }
                tableTxt = tableTxt + "</table>"
                $("#tableSection").empty();
                $("#tableSection").append(tableTxt);
                $("#loader-1").hide();
                $("#sincData").removeAttr("disabled");
            }
        });
    })

    $("#details").click(function () {
        var idContainer = $('#container').val();
        var path = '@Url.Action("Details","Containers2")' + "?id=" + idContainer;
        window.location.href = path;
    });

    $("#removeRow").click(function () {
    var idContainer = $('#container').val();
    var path = '@Url.Action("RemoveRow")' + "?idContainer=" + idContainer;
    window.location.href = path;
    });

    $("#newColumn").click(function () {
    var idContainer = $('#container').val();
    var path = '@Url.Action("AddColumn")' + "?idContainer=" + idContainer;
    window.location.href = path;
    });

    $("#removeColumn").click(function () {
    var idContainer = $('#container').val();
    var path = '@Url.Action("RemoveColumn")' + "?idContainer=" + idContainer;
    window.location.href = path;
    });

    $(".addBtn").click(function () {
        var position = this.id;
        var idContainer = $('#container').val();
        var palletName = $('#palletName').val();
        var path = '@Url.Action("AddPallet")' + "?idContainer=" + idContainer + "&position=" + position + "&palletName=" + palletName;
        window.location.href = path;
    });

    $(".removeBtn").click(function () {
        var palletId = this.id;
        var idContainer = $('#container').val();
        var path = '@Url.Action("RemovePallet")' + "?idContainer=" + idContainer + "&palletId=" + palletId;
        window.location.href = path;
    });
</script>
}

@*<style>
        table {
            display: table;
            empty-cells: show;
        }

        table tr {
            display: table-cell;
        }

        table tr td {
            display: block;
        }
    </style>*@